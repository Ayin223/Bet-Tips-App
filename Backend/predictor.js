import { combinedFixtures } from "./app.js";


const W_RATE = 0.45;    
const W_POINT = 0.30;
const W_GF = 0.15;
const W_GA = 0.10;
const DRAW_THRESHOLD = 0.10;
const MAX_POINT = 20;

const safeNum = (value) => Number(value) || 0;

let totalTips = 0;

const analysis = () => {
  const validTips = combinedFixtures
    .map(match => {
      const {
        completed: matchStatus,
        matchDate,
        matchTime,
        matchID,
        league,
        home: {
          name: homeTeam,
          standing: homeStanding,
          gamesPlayed: homeGamesPlayed,
          homeOdds,
          avgGoalsFor: avgHomeGoalsScored,
          avgGoalsAgainst: avgHomeGoalsConceded,
          winRate: homeWinRate,
          points: homePoints,
        },
        away: {
          name: awayTeam,
          standing: awayStanding,
          gamesPlayed: awayGamesPlayed,
          awayOdds,
          avgGoalsFor: avgAwayGoalsScored,
          avgGoalsAgainst: avgAwayGoalsConceded,
          winRate: awayWinRate,
          points: awayPoints,
        },
        drawOdds,
      } = match;

      const numHomePoints = safeNum(homePoints);
      const numAwayPoints = safeNum(awayPoints);
      const numHomeWinRate = safeNum(homeWinRate) / 100; // Normalize 0-1
      const numAwayWinRate = safeNum(awayWinRate) / 100; // Normalize 0-1
      const numHomeGoalsScored = safeNum(avgHomeGoalsScored);
      const numAwayGoalsScored = safeNum(avgAwayGoalsScored);
      const numHomeGoalsConceded = safeNum(avgHomeGoalsConceded);
      const numAwayGoalsConceded = safeNum(avgAwayGoalsConceded);

      const exclusionFactors =
        safeNum(homeOdds) < 1.80 ||
        safeNum(awayOdds) < 1.80 ||
        safeNum(homeGamesPlayed) < 1 ||
        safeNum(awayGamesPlayed) < 1 ||
        Math.abs(safeNum(homePoints) - safeNum(awayPoints)) < 9;

      if (!matchStatus) {
        if (exclusionFactors) {
          console.log(`â›” Skipped: ${homeTeam} vs ${awayTeam} | homeOdds=${homeOdds}, awayOdds=${awayOdds}, pdiff= ${homePoints - awayPoints}`);
          return null;
        }

        totalTips++;

        const normalizedHomePoints = Math.max(0, MAX_POINT - numHomePoints) / MAX_POINT;
        const normalizedAwayPoints = Math.max(0, MAX_POINT - numAwayPoints) / MAX_POINT;

        // Calculate Score: S = (W_RATE*WinRate) + (W_POINT*NormPoints) + (W_GF*GF) - (W_GA*GA)
        // Note: GF/GA metrics are used directly as modifiers.
        const scoreHome =
            (W_RATE * numHomeWinRate) +
            (W_POINT * normalizedHomePoints) +
            (W_GF * numHomeGoalsScored) -
            (W_GA * numHomeGoalsConceded);

        const scoreAway =
            (W_RATE * numAwayWinRate) +
            (W_POINT * normalizedAwayPoints) +
            (W_GF * numAwayGoalsScored) -
            (W_GA * numAwayGoalsConceded);

        const scoreDiff = scoreHome - scoreAway;

        let prediction;
        let predictedOdds;

        if (Math.abs(scoreDiff) < DRAW_THRESHOLD) {
          prediction = 'Draw';
          predictedOdds = safeNum(drawOdds) || 3.00;
        } else if (scoreDiff > 0) {
          prediction = `${homeTeam} wins`;
          predictedOdds = safeNum(homeOdds);
        } else {
          prediction = `${awayTeam} wins`;
          predictedOdds = safeNum(awayOdds);
        }

        const isPremiumTip = Math.abs(scoreDiff) > (DRAW_THRESHOLD * 2);

        let confidence = 0.50 + Math.min(0.35, Math.abs(scoreDiff * 0.5)); 
        if (isPremiumTip) {
            confidence += 0.05;
        }
        confidence = Math.min(0.90, confidence);

        return {
          league,
          matchDate,
          matchTime,
          matchID,
          homeTeam,
          awayTeam,
          status: matchStatus,
          prediction,
          odds: predictedOdds,
          homeOdds,
          awayOdds,
          drawOdds,
          confidence: parseFloat(confidence.toFixed(2)),
          isPremium: isPremiumTip,
          outcome: "PENDING",
          homeScore: null,
          awayScore: null,
          
          predictionScore: parseFloat(scoreDiff.toFixed(3)),
          homePoints,
          HomeStanding: homeStanding, 
          HomeGamesPlayed: safeNum(homeGamesPlayed),
          awayPoints,
          AwayStanding: awayStanding, 
          AwayGamesPlayed: safeNum(awayGamesPlayed),
          avgHomeGoalsScored, avgHomeGoalsConceded, homeWinRate,
          avgAwayGoalsScored, avgAwayGoalsConceded, awayWinRate,
        };
      } else {
          return match;
      }
    })
    .filter(Boolean);

  console.log(`Total tips generated by new model: ${totalTips}`);
  return validTips;
};

export const betTips = await analysis();

// betTips.forEach(e => 
//   console.log(e)
// )

// const filteredTips = betTips.filter(
//   (tip) => tip.confidence >= 0.60 && tip.confidence <= 0.69
// );

// filteredTips.forEach((tip) => {
//   console.log(`
//   ${tip.homeTeam} vs ${tip.awayTeam}
//   Prediction: ${tip.prediction} @ ${tip.matchDate}
//   Confidence: ${(tip.confidence * 100).toFixed(1)}%  - ${tip.predictedOdds}
//   `);
// });

